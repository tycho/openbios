<rules>

<pre><![CDATA[
#
# Autogenerated OpenBIOS Makefile
# (C) 2004-2005 by the OpenBIOS team
#

ARCH := ppc
ODIR := .
SRCDIR := ..
HOSTCC := gcc
HOSTARCH?=$(shell $(SRCDIR)/config/scripts/archname)
CROSSCFLAGS=$(shell $(SRCDIR)/config/scripts/crosscflags $(HOSTARCH) $(ARCH))
HOSTCFLAGS := -Os -Wall -W -DFCOMPILER -DBOOTSTRAP $(CROSSCFLAGS)
HOSTCFLAGS+= -Wredundant-decls -Wshadow -Wpointer-arith -Wstrict-prototypes -Wmissing-declarations
HOSTCFLAGS+= -Wundef -Wendif-labels -Wstrict-aliasing -Wwrite-strings -Wmissing-prototypes
HOSTINCLUDES := -I$(SRCDIR)/include -I$(SRCDIR)/kernel -I$(SRCDIR)/kernel/include -I$(ODIR)/target/include
#
# MOLPATH is needed if you want to build openbios-mol.elf
#
MOLPATH=$(HOME)/mol-0.9.71

TARGET=powerpc-unknown-linux-gnu-
CC     := $(TARGET)gcc
AS     := $(TARGET)as
AR     := $(TARGET)ar
LD     := $(TARGET)ld
NM     := $(TARGET)nm
STRIP  := $(TARGET)strip
RANLIB := $(TARGET)ranlib
CFLAGS := -Os -Wall -msoft-float -DNATIVE_BITWIDTH_EQUALS_HOST_BITWIDTH -USWAP_ENDIANNESS -fno-builtin-bcopy -fno-builtin-log2
CFLAGS+= -Wredundant-decls -Wshadow -Wpointer-arith -Wstrict-prototypes -Wmissing-declarations -Werror
CFLAGS+= -Wundef -Wendif-labels -Wstrict-aliasing -Wwrite-strings -Wmissing-prototypes
INCLUDES := -I$(SRCDIR)/include -I$(SRCDIR)/kernel/include -I$(ODIR)/target/include

M4 := m4

#
# pre rules
#

all: mol versions dictionaries host-libraries target-libraries host-executables target-executables

VERSION := "1.0"

versions: $(ODIR)/target/include/openbios-version.h $(ODIR)/forth/version.fs

$(ODIR)/forth/version.fs:
	@DATE="$(shell echo `LC_ALL=C TZ=UTC date +'%b %e %Y %H:%M'`)" ;  \
		( echo ": builddate \" $$DATE\" ; " ;     \
		  echo ": version \" $(VERSION)\" ; " ; ) \
		  > $(dir $@)/version.fs

$(ODIR)/target/include/openbios-version.h:
	@DATE="$(shell echo `LC_ALL=C TZ=UTC date +'%b %e %Y %H:%M'`)" ; \
          ( echo "#define OPENBIOS_BUILD_DATE \"$$DATE\"" ; \
           echo "#define OPENBIOS_VERSION_STR \"$(VERSION)\"" ; \
           echo "#define OPENBIOS_RELEASE \"$(VERSION)\"" ; ) \
         > $(dir $@)/openbios-version.h
mol:
	@grep CONFIG_MOL $(ODIR)/forth/config.fs >/dev/null && ( \
	echo "Using MOL path $(MOLPATH)..."; \
	ln -s $(MOLPATH)/src/shared/osi_calls.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/shared/osi.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/shared/prom.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/include/boothelper_sh.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/include/video_sh.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/include/pseudofs_sh.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/include/kbd_sh.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/drivers/disk/include/scsi_sh.h $(ODIR)/target/include/; \
	ln -s $(MOLPATH)/src/drivers/disk/include/ablk_sh.h $(ODIR)/target/include/ ) || true

]]></pre>

 <!-- host compiler build rules -->

<rule target="host" entity="executable">
	$(HOSTCC) $(HOSTCFLAGS) -o $@ $^
</rule>

<rule target="host" entity="object">
	$(HOSTCC) $(HOSTCFLAGS) $(HOSTINCLUDES) -c -o $@ $^
</rule>

<rule target="host" entity="library">
	$(AR) cru $@ $^; ranlib $@
</rule>

 <!-- target/cross compiler build rules -->

<rule target="target" entity="executable">
	$(CC) $(CFLAGS) -o $@ $^
</rule>

<rule target="target" entity="object">
	$(CC) $$EXTRACFLAGS $(CFLAGS) $(INCLUDES) -c -o $@ $^
</rule>

<rule target="target" entity="library">
	$(AR) cru $@ $^; $(RANLIB) $@
</rule>

</rules>
